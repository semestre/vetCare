<ion-header class="header-white no-translucent">
  <ion-toolbar color="transparent">
    <div class="header-row">
      <ion-title class="title">
        <ion-icon name="paw-outline" aria-hidden="true"></ion-icon>
        Citas de Veterinaria
      </ion-title>

      <ion-searchbar
        placeholder="Buscar por motivo, fecha, vet, paciente..."
        (ionInput)="onSearchChange($event)"
        show-clear-button="focus"
        animated="true">
      </ion-searchbar>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding content-bg">

  <!-- üéõÔ∏è Controles (Filtros + Nueva cita) -->
  <div class="controls container">
    <div class="filters">
      <!-- Filtros por estado en espa√±ol -->
      <ion-segment value="todas" mode="md" (ionChange)="onStatusFilterChange($event)">
        <ion-segment-button value="todas">
          <ion-label>Todas</ion-label>
        </ion-segment-button>
        <ion-segment-button value="pendiente">
          <ion-label>En proceso</ion-label>
        </ion-segment-button>
        <ion-segment-button value="completada">
          <ion-label>Completadas</ion-label>
        </ion-segment-button>
        <ion-segment-button value="cancelada">
          <ion-label>Canceladas</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <div class="actions">
      <ion-button fill="solid" color="primary" (click)="nuevaCita()">
        <ion-icon slot="start" name="add-outline"></ion-icon>
        Nueva cita
      </ion-button>
    </div>
  </div>

  <!-- Skeleton de carga -->
  <ng-container *ngIf="loading">
    <ion-grid fixed>
      <ion-row>
        <ion-col size="12" size-md="6" size-lg="4" *ngFor="let s of [1,2,3,4,5,6]">
          <ion-card class="card glass">
            <ion-card-header>
              <ion-card-title>
                <ion-skeleton-text animated style="width: 70%"></ion-skeleton-text>
              </ion-card-title>
              <ion-card-subtitle>
                <ion-skeleton-text animated style="width: 40%"></ion-skeleton-text>
              </ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              <ion-skeleton-text animated style="width: 90%"></ion-skeleton-text>
              <ion-skeleton-text animated style="width: 60%"></ion-skeleton-text>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ng-container>

  <!-- Error -->
  <ion-card *ngIf="!loading && error" class="card error-card">
    <ion-card-header>
      <ion-card-title>Ups</ion-card-title>
      <ion-card-subtitle>{{ error }}</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <ion-button fill="outline" (click)="load()">Reintentar</ion-button>
    </ion-card-content>
  </ion-card>

  <!-- Vac√≠o -->
  <div *ngIf="!loading && !filteredCitas().length" class="empty">
    <div class="emoji">üêæ</div>
    <h3>Sin citas por ahora</h3>
    <p>Cuando registres una cita aparecer√° aqu√≠.</p>
    <ion-button (click)="nuevaCita()">Nueva cita</ion-button>
  </div>

  <!-- Grid de tarjetas -->
  <ion-grid fixed *ngIf="!loading && filteredCitas().length">
    <ion-row>
      <ion-col size="12" size-md="6" size-lg="4" *ngFor="let cita of filteredCitas(); let i = index">

        <div class="card-wrap">
          <div class="card-badge" [ngClass]="'color-' + ((i % 4) + 1)">
            <ion-icon name="medkit-outline"></ion-icon>
          </div>

          <ion-card class="card glass hover">
            <ion-card-header>
              <ion-card-title class="motivo">
                <ion-icon name="paw-outline"></ion-icon>
                {{ cita.motivo }}
              </ion-card-title>

              <ion-card-subtitle class="ids">
                <ion-chip class="soft">
                  <ion-icon name="person-outline"></ion-icon>
                  <ion-label>Vet #{{ cita.idVeterinario }}</ion-label>
                </ion-chip>
                <ion-chip class="soft">
                  <ion-icon name="paw-outline"></ion-icon>
                  <ion-label>Paciente #{{ cita.idPaciente }} {{ cita.pacienteNombre }}</ion-label>
                </ion-chip>
              </ion-card-subtitle>

              <!-- Status + acciones -->
              <div class="status-row">
                <!-- Chip clickeable para cambiar estado -->
                <ion-chip
                  class="status-chip"
                  [color]="getStatusColor(cita.status)"
                  outline="true"
                  (click)="openStatusPopover($event, cita)"
                >
                  <ion-icon name="ellipse" slot="start"></ion-icon>
                  <ion-label>{{ getStatusLabel(cita.status) }}</ion-label>
                </ion-chip>

                <div class="card-actions">
                  <ion-button size="small" fill="clear" (click)="editarCita(cita)">
                    <ion-icon name="create-outline" slot="icon-only"></ion-icon>
                  </ion-button>

                  <ion-button size="small" fill="clear" color="danger" (click)="eliminarCita(cita)">
                    <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
                  </ion-button>
                </div>
              </div>
            </ion-card-header>

            <ion-card-content>
              <div class="meta">
                <div class="meta-item">
                  <span class="meta-k">Fecha: </span>
                  <span class="meta-v">{{ cita.fecha }}</span>
                </div>
                <div class="meta-item">
                  <span class="meta-k">Hora: </span>
                  <span class="meta-v">{{ cita.hora }}</span>
                </div>
                <div class="meta-item">
                  <span class="meta-k">Motivo: </span>
                  <span class="meta-v">{{ cita.motivo }}</span>
                </div>
              </div>

              <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: flex-end;">
                <ion-button size="small" fill="outline" (click)="editarCita(cita)">
                  Editar
                </ion-button>

                <ion-button size="small" color="danger" fill="outline" (click)="eliminarCita(cita)">
                  Eliminar
                </ion-button>
              </div>
            </ion-card-content>
          </ion-card>
        </div>

      </ion-col>
    </ion-row>
  </ion-grid>

  <!-- Popover para cambio r√°pido de estado -->
  <ion-popover
  [isOpen]="statusPopoverOpen"
  [event]="statusPopoverEvent"
  (didDismiss)="onStatusPopoverDismiss()"
  cssClass="status-popover-white"
>
  <ng-template>
    <div class="status-card">

      <div class="status-title">Estado de la cita</div>

      <button class="status-option" (click)="changeStatusFromPopover('pendiente')">
        <div class="left">
          <ion-icon name="time-outline" color="warning" class="icon"></ion-icon>
          <span>Pendiente</span>
        </div>
        <ion-icon
          *ngIf="currentStatusIs('pendiente')"
          name="checkmark-outline"
          color="success"
          class="check">
        </ion-icon>
      </button>

      <button class="status-option" (click)="changeStatusFromPopover('completada')">
        <div class="left">
          <ion-icon name="checkmark-circle-outline" color="success" class="icon"></ion-icon>
          <span>Completada</span>
        </div>
        <ion-icon
          *ngIf="currentStatusIs('completada')"
          name="checkmark-outline"
          color="success"
          class="check">
        </ion-icon>
      </button>

      <button class="status-option" (click)="changeStatusFromPopover('cancelada')">
        <div class="left">
          <ion-icon name="close-circle-outline" color="danger" class="icon"></ion-icon>
          <span>Cancelada</span>
        </div>
        <ion-icon
          *ngIf="currentStatusIs('cancelada')"
          name="checkmark-outline"
          color="danger"
          class="check">
        </ion-icon>
      </button>

    </div>
  </ng-template>
</ion-popover>

</ion-content>
