<!-- DiÃ¡logo centrado -->
<div class="dialog">

  <!-- Header -->
  <div class="dialog-header">
    <h2>{{ factura ? 'Editar factura' : 'Nueva factura' }}</h2>
    <ion-button (click)="close()" fill="clear" aria-label="Cerrar" size="small">
      <ion-icon slot="icon-only" name="close-outline"></ion-icon>
    </ion-button>
  </div>

  <!-- Body -->
  <div class="dialog-body">
    <form [formGroup]="form" (ngSubmit)="save()" class="form-body" novalidate>


      <!-- ========================================================= -->
      <!-- ðŸ”¹ SELECCIÃ“N DE PACIENTE (buscador y chip en una sola lÃ­nea) -->
      <!-- ========================================================= -->

      <ion-list inset="true" class="group">

        <!-- CONTENEDOR UNIFICADO: buscador Ã³ selecciÃ³n -->
        <div class="paciente-inline">

          <!-- â­ MODO BUSCADOR (si NO hay seleccionado) -->
          <div class="search-mode" *ngIf="!selectedPaciente">
            <ion-icon name="search-outline" class="icon"></ion-icon>

            <ion-input
              placeholder="Buscar paciente..."
              (ionInput)="onSearchPaciente($event)"
              clear-input="true"
              debounce="200"
              class="search-input">
            </ion-input>
          </div>

          <!-- â­ MODO PACIENTE SELECCIONADO (chip) -->
          <div class="selected-mode" *ngIf="selectedPaciente" (click)="clearPacienteSelection()">
            <ion-icon name="paw-outline" class="icon"></ion-icon>

            <div class="text">
              #{{ selectedPaciente.idPaciente }} - {{ selectedPaciente.nombreMascota }}
            </div>

            <ion-icon name="close-circle-outline" class="close"></ion-icon>
          </div>

        </div>

        <!-- RESULTADOS DEL BUSCADOR -->
        <div class="search-results" *ngIf="!selectedPaciente && pacientesFiltrados.length && searchPacienteTerm">
          <ion-list lines="none">
            <ion-item
              button
              detail="false"
              class="result-item"
              *ngFor="let p of pacientesFiltrados"
              (click)="selectPaciente(p)">
              
              <ion-avatar slot="start">
                <div class="avatar-circle">
                  {{ (p.nombreMascota || '?')[0] | uppercase }}
                </div>
              </ion-avatar>

              <ion-label>
                <h3>#{{ p.idPaciente }} - {{ p.nombreMascota }}</h3>
                <p>{{ p.especie || 'â€”' }}<span *ngIf="p.raza"> Â· {{ p.raza }}</span></p>
              </ion-label>

            </ion-item>
          </ion-list>
        </div>

        <!-- Mensaje sin resultados -->
        <div class="no-results" *ngIf="!pacientesFiltrados.length && searchPacienteTerm">
          <ion-icon name="alert-circle-outline"></ion-icon>
          <p>No se encontraron pacientes.</p>
        </div>

        <!-- ValidaciÃ³n -->
        <ion-note color="danger" *ngIf="form.get('idPaciente')?.touched && form.get('idPaciente')?.invalid">
          Selecciona un paciente vÃ¡lido.
        </ion-note>


        <!-- ========================================================= -->
        <!-- ðŸ”¹ CAMPOS DE FACTURA -->
        <!-- ========================================================= -->

        <ion-item>
          <ion-icon name="medkit-outline" slot="start"></ion-icon>
          <ion-textarea
            label="Servicios"
            labelPlacement="stacked"
            auto-grow="true"
            placeholder="Consulta, cirugÃ­a, etc."
            formControlName="servicios">
          </ion-textarea>
        </ion-item>
        <ion-note color="danger" *ngIf="form.get('servicios')?.touched && form.get('servicios')?.invalid">
          Escribe al menos 3 caracteres.
        </ion-note>

        <ion-item>
          <ion-icon name="flask-outline" slot="start"></ion-icon>
          <ion-textarea
            label="Medicamentos"
            labelPlacement="stacked"
            auto-grow="true"
            placeholder="Vacunas, anestesia, etc."
            formControlName="medicamentos">
          </ion-textarea>
        </ion-item>

      </ion-list>



      <ion-list inset="true" class="group">
        <ion-item>
          <ion-icon name="pricetag-outline" slot="start"></ion-icon>
          <ion-input
            type="number"
            step="0.01"
            inputmode="decimal"
            label="Total"
            labelPlacement="stacked"
            formControlName="total">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-icon name="calendar-outline" slot="start"></ion-icon>
          <ion-input
            type="date"
            label="Fecha"
            labelPlacement="stacked"
            formControlName="fecha">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-icon name="card-outline" slot="start"></ion-icon>
          <ion-select
            label="MÃ©todo de pago"
            labelPlacement="stacked"
            formControlName="metodoPago"
            interface="popover">
            <ion-select-option value="Efectivo">Efectivo</ion-select-option>
            <ion-select-option value="Tarjeta">Tarjeta</ion-select-option>
            <ion-select-option value="Transferencia">Transferencia</ion-select-option>
          </ion-select>
        </ion-item>
      </ion-list>

      <div class="bottom-space"></div>
    </form>
  </div>

  <!-- Footer -->
  <div class="dialog-footer">
    <ion-button fill="outline" color="medium" (click)="close()">Cancelar</ion-button>
    <ion-button type="submit" (click)="save()">
      <ion-icon slot="start" name="save-outline"></ion-icon>
      Guardar
    </ion-button>
  </div>

</div>
