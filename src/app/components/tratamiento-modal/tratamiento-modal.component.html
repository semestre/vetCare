<!-- Diálogo centrado -->
<div class="dialog">

  <!-- Header -->
  <div class="dialog-header">
    <h2>{{ isEdit ? 'Editar tratamiento' : 'Nuevo tratamiento' }}</h2>
    <ion-button (click)="close()" fill="clear" aria-label="Cerrar" size="small">
      <ion-icon slot="icon-only" name="close-outline"></ion-icon>
    </ion-button>
  </div>

  <!-- Body (scrollable) -->
  <div class="dialog-body">
    <form [formGroup]="form" (ngSubmit)="save()" class="form-body" novalidate>

      <ion-list inset="true" class="group">
        <!-- Descripción -->
        <ion-item>
          <ion-icon name="medkit-outline" slot="start"></ion-icon>
          <ion-input
            label="Descripción"
            labelPlacement="stacked"
            formControlName="descripcion"
            placeholder="Vacuna, limpieza dental…">
          </ion-input>
        </ion-item>
        <ion-note color="danger" *ngIf="form.get('descripcion')?.touched && form.get('descripcion')?.invalid">
          Escribe al menos 3 caracteres.
        </ion-note>

        <!-- Tipo -->
        <ion-item>
          <ion-icon name="flask-outline" slot="start"></ion-icon>
          <ion-select
            label="Tipo"
            labelPlacement="stacked"
            interface="popover"
            formControlName="tipo">
            <ion-select-option value="Vacuna">Vacuna</ion-select-option>
            <ion-select-option value="Higiene">Higiene</ion-select-option>
            <ion-select-option value="Cirugía">Cirugía</ion-select-option>
            <ion-select-option value="Desparasitación">Desparasitación</ion-select-option>
            <ion-select-option value="Control">Control</ion-select-option>
            <ion-select-option value="Otro">Otro</ion-select-option>
          </ion-select>
        </ion-item>

        <!-- Fecha -->
        <ion-item>
          <ion-icon name="calendar-outline" slot="start"></ion-icon>
          <ion-input
            type="date"
            label="Fecha"
            labelPlacement="stacked"
            formControlName="fecha">
          </ion-input>
        </ion-item>

        <!-- ========================= -->
        <!--   PACIENTE: buscador/chip -->
        <!-- ========================= -->

        <div class="paciente-inline">
          <!-- Modo buscador -->
          <div class="search-mode" *ngIf="!selectedPaciente">
            <ion-icon name="search-outline" class="icon"></ion-icon>
            <ion-input
              placeholder="Buscar paciente..."
              (ionInput)="onSearchPaciente($event)"
              clear-input="true"
              debounce="200"
              class="search-input">
            </ion-input>
          </div>

          <!-- Modo seleccionado -->
          <div class="selected-mode" *ngIf="selectedPaciente" (click)="clearPacienteSelection()">
            <ion-icon name="paw-outline" class="icon"></ion-icon>
            <div class="text">
              #{{ selectedPaciente.idPaciente }} - {{ selectedPaciente.nombreMascota }}
            </div>
            <ion-icon name="close-circle-outline" class="close"></ion-icon>
          </div>
        </div>

        <!-- Resultados -->
        <div class="search-results" *ngIf="!selectedPaciente && pacientesFiltrados.length && searchPacienteTerm">
          <ion-list lines="none">
            <ion-item
              button
              detail="false"
              class="result-item"
              *ngFor="let p of pacientesFiltrados"
              (click)="selectPaciente(p)">
              <ion-avatar slot="start">
                <div class="avatar-circle">
                  {{ (p.nombreMascota || '?')[0] | uppercase }}
                </div>
              </ion-avatar>
              <ion-label>
                <h3>#{{ p.idPaciente }} - {{ p.nombreMascota }}</h3>
                <p>{{ p.especie || '—' }}<span *ngIf="p.raza"> · {{ p.raza }}</span></p>
              </ion-label>
            </ion-item>
          </ion-list>
        </div>

        <!-- Sin resultados -->
        <div class="no-results" *ngIf="!selectedPaciente && !pacientesFiltrados.length && searchPacienteTerm">
          <ion-icon name="alert-circle-outline"></ion-icon>
          <p>No se encontraron pacientes.</p>
        </div>

        <!-- Validación -->
        <ion-note color="danger" *ngIf="form.get('idPaciente')?.touched && form.get('idPaciente')?.invalid">
          Selecciona un paciente válido.
        </ion-note>

      </ion-list>

      <div class="bottom-space"></div>
    </form>
  </div>

  <!-- Footer fijo -->
  <div class="dialog-footer">
    <ion-button fill="outline" color="medium" (click)="close()">Cancelar</ion-button>
    <ion-button type="submit" (click)="save()">
      <ion-icon slot="start" name="save-outline"></ion-icon>
      {{ isEdit ? 'Actualizar' : 'Guardar' }}
    </ion-button>
  </div>

</div>
