<!-- DiÃ¡logo centrado -->
<div class="dialog">

  <!-- Header -->
  <div class="dialog-header">
    <h2>{{ isEdit ? 'Editar tratamiento' : 'Nuevo tratamiento' }}</h2>
    <ion-button (click)="close()" fill="clear" aria-label="Cerrar" size="small">
      <ion-icon slot="icon-only" name="close-outline"></ion-icon>
    </ion-button>
  </div>

  <!-- Body (scrollable) -->
  <div class="dialog-body">
    <form [formGroup]="form" (ngSubmit)="save()" class="form-body" novalidate>

      <ion-list inset="true" class="group">

        <!-- DescripciÃ³n -->
        <ion-item>
          <ion-icon name="medkit-outline" slot="start"></ion-icon>
          <ion-input
            label="DescripciÃ³n"
            labelPlacement="stacked"
            formControlName="descripcion"
            placeholder="Vacuna, limpieza dentalâ€¦">
          </ion-input>
        </ion-item>
        <ion-note color="danger" *ngIf="form.get('descripcion')?.touched && form.get('descripcion')?.invalid">
          Escribe al menos 3 caracteres.
        </ion-note>

        <!-- Tipo -->
        <ion-item>
          <ion-icon name="flask-outline" slot="start"></ion-icon>
          <ion-select label="Tipo" labelPlacement="stacked" interface="popover" formControlName="tipo">
            <ion-select-option value="Vacuna">Vacuna</ion-select-option>
            <ion-select-option value="Higiene">Higiene</ion-select-option>
            <ion-select-option value="CirugÃ­a">CirugÃ­a</ion-select-option>
            <ion-select-option value="DesparasitaciÃ³n">DesparasitaciÃ³n</ion-select-option>
            <ion-select-option value="Control">Control</ion-select-option>
            <ion-select-option value="Otro">Otro</ion-select-option>
          </ion-select>
        </ion-item>

        <!-- Fecha -->
        <ion-item>
          <ion-icon name="calendar-outline" slot="start"></ion-icon>
          <ion-input type="date" label="Fecha" labelPlacement="stacked" formControlName="fecha">
          </ion-input>
        </ion-item>

        <!-- ========================= -->
        <!-- ðŸ”½ PACIENTE: dropdown con buscador -->
        <!-- ========================= -->

        <ion-list inset="true" class="group">

          <!-- Header del dropdown -->
          <ion-item button detail="true" (click)="togglePacienteSelector()">
            <ion-icon name="paw-outline" slot="start"></ion-icon>
            <ion-label>
              <h3>Paciente</h3>

              <p class="paciente-placeholder">
                {{ pacienteSeleccionadoLabel || 'Toca para seleccionar un paciente' }}
              </p>
            </ion-label>
          </ion-item>

          <!-- ValidaciÃ³n -->
          <ion-note color="danger" *ngIf="form.get('idPaciente')?.touched && form.get('idPaciente')?.invalid">
            Selecciona un paciente vÃ¡lido.
          </ion-note>

          <!-- Cuerpo del dropdown -->
          <div *ngIf="pacienteSelectorAbierto" class="pacientes-dropdown">

            <!-- Searchbar -->
            <ion-searchbar
              placeholder="Buscar por nombre o IDâ€¦"
              (ionInput)="onPacienteSearch($event)"
              [value]="pacienteBusqueda"
              show-clear-button="focus">
            </ion-searchbar>

            <ion-list>

              <!-- Items filtrados -->
              <ion-item
                button
                detail="false"
                class="paciente-item"
                *ngFor="let p of pacientesFiltrados"
                (click)="seleccionarPaciente(p)">

                <ion-avatar slot="start" class="avatar-circle">
                  <div class="circle-content">
                    {{ p.nombreMascota?.charAt(0)?.toUpperCase() }}
                  </div>
                </ion-avatar>

                <ion-label>
                  <h3>#{{ p.idPaciente }} - {{ p.nombreMascota }}</h3>
                  <p>{{ p.especie || 'â€”' }}<span *ngIf="p.raza"> Â· {{ p.raza }}</span></p>
                </ion-label>

              </ion-item>

              <!-- Sin resultados -->
              <ion-item *ngIf="!pacientesFiltrados.length">
                <ion-label>Sin resultados</ion-label>
              </ion-item>

            </ion-list>
          </div>

        </ion-list>

      </ion-list>

      <div class="bottom-space"></div>
    </form>
  </div>

  <!-- Footer fijo -->
  <div class="dialog-footer">
    <ion-button fill="outline" color="medium" (click)="close()">Cancelar</ion-button>
    <ion-button type="submit" (click)="save()">
      <ion-icon slot="start" name="save-outline"></ion-icon>
      {{ isEdit ? 'Actualizar' : 'Guardar' }}
    </ion-button>
  </div>

</div>
