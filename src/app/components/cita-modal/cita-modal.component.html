<div class="dialog">

  <!-- Header -->
  <div class="dialog-header">
    <h2>{{ cita ? 'Editar cita' : 'Nueva cita' }}</h2>
    <ion-button (click)="close()" fill="clear" aria-label="Cerrar" size="small">
      <ion-icon name="close-outline" slot="icon-only"></ion-icon>
    </ion-button>
  </div>

  <!-- Body (scrollable) -->
  <div class="dialog-body">
    <form [formGroup]="form" (ngSubmit)="save()" class="form-body" novalidate>

      <ion-list inset="true" class="group">
        <ion-item>
          <ion-icon name="calendar-outline" slot="start"></ion-icon>
          <ion-input type="date" label="Fecha" labelPlacement="stacked" formControlName="fecha"></ion-input>
        </ion-item>
        <ion-note color="danger" *ngIf="form.get('fecha')?.touched && form.get('fecha')?.invalid">
          La fecha es obligatoria.
        </ion-note>

        <ion-item>
          <ion-icon name="time-outline" slot="start"></ion-icon>
          <ion-input type="time" label="Hora" labelPlacement="stacked" formControlName="hora"></ion-input>
        </ion-item>
        <ion-note color="danger" *ngIf="form.get('hora')?.touched && form.get('hora')?.invalid">
          La hora es obligatoria.
        </ion-note>
      </ion-list>

      <ion-list inset="true" class="group">
        <ion-item>
          <ion-icon name="medkit-outline" slot="start"></ion-icon>
          <ion-textarea label="Motivo" labelPlacement="stacked" auto-grow="true"
                        placeholder="Vacunación, Chequeo general, etc." formControlName="motivo">
          </ion-textarea>
        </ion-item>
        <ion-note color="danger" *ngIf="form.get('motivo')?.touched && form.get('motivo')?.invalid">
          Escribe al menos 3 caracteres.
        </ion-note>
      </ion-list>

      <!-- Veterinario -->
      <ion-list inset="true" class="group">
        <ion-item>
          <ion-icon name="person-outline" slot="start"></ion-icon>
          <ion-select label="Veterinario" labelPlacement="stacked" interface="popover" formControlName="idVeterinario">
            <ion-select-option *ngFor="let vet of veterinarios" [value]="vet.idUsuario">
              {{ vet.idUsuario }} - {{ vet.nombreUsuario }}
            </ion-select-option>
          </ion-select>
        </ion-item>
        <ion-note color="danger" *ngIf="form.get('idVeterinario')?.touched && form.get('idVeterinario')?.invalid">
          Ingresa un veterinario válido.
        </ion-note>
      </ion-list>

      <!-- Paciente con buscador tipo dropdown -->
      <ion-list inset="true" class="group">
        <!-- Cabecera del dropdown -->
        <ion-item button detail="true" (click)="togglePacienteSelector()">
          <ion-icon name="paw-outline" slot="start"></ion-icon>
          <ion-label>
            <h3>Paciente</h3>
            <p class="paciente-placeholder">
              {{ pacienteSeleccionadoLabel || 'Toca para seleccionar un paciente' }}
            </p>
          </ion-label>
        </ion-item>
        <ion-note color="danger" *ngIf="form.get('idPaciente')?.touched && form.get('idPaciente')?.invalid">
          Ingresa un paciente válido.
        </ion-note>

        <!-- Cuerpo del dropdown -->
        <div *ngIf="pacienteSelectorAbierto" class="pacientes-dropdown">
          <ion-searchbar
            placeholder="Buscar por nombre o ID..."
            (ionInput)="onPacienteSearch($event)"
            [value]="pacienteBusqueda"
            show-clear-button="focus">
          </ion-searchbar>

          <ion-list>
            <ion-item
              button
              detail="false"
              *ngFor="let p of pacientesFiltrados"
              (click)="seleccionarPaciente(p)">
              {{ p.idPaciente }} - {{ p.nombreMascota }}
            </ion-item>

            <ion-item *ngIf="!pacientesFiltrados.length">
              <ion-label>Sin resultados</ion-label>
            </ion-item>
          </ion-list>
        </div>
      </ion-list>

      <!-- Estado -->
      <ion-list inset="true" class="group">
        <ion-item>
          <ion-icon name="flag-outline" slot="start"></ion-icon>
          <ion-select label="Estado" labelPlacement="stacked"
                      interface="popover" formControlName="status">
            <ion-select-option value="Programada">Programada</ion-select-option>
            <ion-select-option value="En proceso">En proceso</ion-select-option>
            <ion-select-option value="Completada">Completada</ion-select-option>
            <ion-select-option value="Cancelada">Cancelada</ion-select-option>
          </ion-select>
        </ion-item>
      </ion-list>

      <div class="bottom-space"></div>
    </form>
  </div>

  <!-- Footer -->
  <div class="dialog-footer">
    <ion-button fill="outline" color="medium" (click)="close()">Cancelar</ion-button>
    <ion-button type="submit" (click)="save()">
      <ion-icon slot="start" name="save-outline"></ion-icon>
      Guardar
    </ion-button>
  </div>

</div>
